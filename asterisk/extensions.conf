; ═══════════════════════════════════════════════════════════════════════
; Dialplan for Centro de Control
; ═══════════════════════════════════════════════════════════════════════

[general]
static=yes
writeprotect=no

; ─── Internal calls between extensions ────────────────────────────────
[from-internal]
; Agent-to-agent internal calls
exten => _1XXX,1,NoOp(Internal call to ${EXTEN})
 same => n,Dial(PJSIP/${EXTEN},30,tTkK)
 same => n,Hangup()

; Outbound calls via default trunk
exten => _X.,1,NoOp(Outbound call to ${EXTEN})
 same => n,Set(CDR(userfield)=${CALL_RECORD_ID})
 same => n,Set(CHANNEL(hangup_handler_push)=hangup-handler,s,1)
 same => n,MixMonitor(/var/spool/asterisk/recording/${UNIQUEID}.wav,b)
 same => n,Dial(PJSIP/${EXTEN}@outbound,${IF($["${RING_TIMEOUT}"=""]?30:${RING_TIMEOUT})},tTkKgG)
 same => n,Set(DIALSTATUS_SAVED=${DIALSTATUS})
 same => n,GotoIf($["${DIALSTATUS_SAVED}" = "ANSWER"]?answered)
 same => n,GotoIf($["${DIALSTATUS_SAVED}" = "BUSY"]?busy)
 same => n,GotoIf($["${DIALSTATUS_SAVED}" = "NOANSWER"]?noanswer)
 same => n,Goto(failed)
 same => n(answered),Hangup()
 same => n(busy),Hangup()
 same => n(noanswer),Hangup()
 same => n(failed),Hangup()

; ─── Inbound from SIP trunk ───────────────────────────────────────────
[from-external]
exten => _X.,1,NoOp(Inbound call from ${CALLERID(num)} to ${EXTEN})
 same => n,Set(CDR(userfield)=inbound)
 same => n,MixMonitor(/var/spool/asterisk/recording/${UNIQUEID}.wav,b)
 same => n,Answer()
 same => n,Playback(silence/1)
 same => n,Hangup()

; ─── Hangup handler (for recording cleanup, etc.) ─────────────────────
[hangup-handler]
exten => s,1,NoOp(Hangup handler for ${CHANNEL(uniqueid)})
 same => n,StopMixMonitor()
 same => n,Return()
